#!/bin/bash
# Comando "Glog"
# arg1
#   comando
# arg2
#   Mensaje
# arg3 (opcional)
#   tipo de mensaje. 
#   default: debug
#   opciones: debug info warn error

#./bin/glog auxiliarCommand mensaje1 debug
#./bin/glog anOtherCommand mensaje2 error
#./bin/glog auxiliarCommand mensaje3

#TODO: documentar, documentar logsize, help menu, 



#revisar si un elemento existe en un array
array_contains () { 
    local array="$1[@]"
    local seeking=$2
    local in=1
    for element in "${!array}"; do
        if [[ $element == $seeking ]]; then
            in=0
            break
        fi
    done
    return $in
}

generar_log () {

    TIPOS=("INFO" "WAR" "ERR")
    TIPO_DEFAULT="INFO"

    TIMESTAMP=`date +"%Y-%m-%d_%H-%M-%S"`

    array_contains TIPOS $TIPO  && TIPO=$TIPO || TIPO=$TIPO_DEFAULT


    AUTOR=$(whoami);
    log="$TIMESTAMP - $TIPO - $AUTOR - $COMANDO - $MENSAJE"

    echo "$log" >> "$LOGFILE"

}


controlar_crecimiento_logfile (){

    LOGFILE_SIZE=`wc -l "$LOGFILE" | xargs | cut -f1 -d' '`

    if [[ "$LOGFILE_SIZE" -gt $LOGSIZE ]]; then
        tail -$LOGSAVE "$LOGFILE" > "${LOGFILE}save"
        mv "${LOGFILE}save" "$LOGFILE"
    fi

}
############################################


COMANDO="$1"
MENSAJE="$2"
TIPO="$3"

LOGSIZE="2000"
LOGSAVE="100" #logs que se guardan al reiniciar archivo
LOGDIR="/home/pc/Escritorio/TPSO/Git/sisop-4h/log/"
mkdir -p "$LOGDIR"
LOGFILE="${LOGDIR}$COMANDO.log"
GENERAL_LOGFILE="${LOGDIR}salida.log"

generar_log
controlar_crecimiento_logfile

